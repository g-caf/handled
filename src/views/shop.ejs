<h1>Your Groceries</h1>

<% if (error) { %>
  <div class="card" style="border-color: #8b2525; margin-bottom: 1.5rem;">
    <p style="color: #cc4444; margin: 0;"><%= error %></p>
  </div>
<% } %>

<% if (message) { %>
  <div class="card" style="border-color: var(--accent); margin-bottom: 1.5rem;">
    <p style="color: var(--accent); margin: 0;"><%= message %></p>
  </div>
<% } %>

<% if (suggestions.length > 0) { %>
  <div style="margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
    <span class="badge">Updated <%= new Date(lastFetched).toLocaleTimeString() %></span>
    <a href="/shop/auto-import" class="btn btn-sm">↻ Refresh</a>
  </div>

  <div class="card" style="padding: 0; overflow-x: auto;">
    <table class="table" style="margin: 0;">
      <thead>
        <tr>
          <th>Item</th>
          <th style="text-align: center;">Ordered</th>
          <th style="text-align: right;">Lowest</th>
          <th style="text-align: right;">Highest</th>
          <th style="text-align: center;">Qty</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% suggestions.forEach((item, idx) => { %>
          <tr>
            <td>
              <strong><%= item.name %></strong>
              <% if (item.lowestPrice?.platform) { %>
                <br><span class="badge" style="font-size: 0.7rem;"><%= item.lowestPrice.platform %></span>
              <% } %>
            </td>
            <td style="text-align: center;"><%= item.count %>×</td>
            <td style="text-align: right;">
              <% if (item.lowestPrice?.price) { %>
                <span style="color: var(--accent);">$<%= item.lowestPrice.price.toFixed(2) %></span>
              <% } else { %>
                —
              <% } %>
            </td>
            <td style="text-align: right;">
              <% if (item.highestPrice?.price) { %>
                $<%= item.highestPrice.price.toFixed(2) %>
              <% } else { %>
                —
              <% } %>
            </td>
            <td style="text-align: center;">
              <input 
                type="number" 
                id="qty-<%= idx %>" 
                value="1" 
                min="1" 
                max="99"
                style="width: 50px; text-align: center; padding: 0.3rem;"
              >
            </td>
            <td>
              <form action="/shop/add-to-cart" method="POST" style="display: inline;">
                <input type="hidden" name="itemName" value="<%= item.name %>">
                <input type="hidden" name="platform" value="<%= item.lowestPrice?.platform || '' %>">
                <input type="hidden" name="storeUrl" value="<%= item.lowestPrice?.storeUrl || '' %>">
                <input type="hidden" name="quantity" value="1" class="qty-input" data-idx="<%= idx %>">
                <button type="submit" class="btn btn-sm btn-primary">+ Add</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <script>
    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('change', function() {
        const idx = this.id.replace('qty-', '');
        document.querySelectorAll(`.qty-input[data-idx="${idx}"]`).forEach(hidden => {
          hidden.value = this.value;
        });
      });
    });
  </script>

<% } else { %>
  <div class="card">
    <p class="empty-state">
      <% if (lastFetched) { %>
        No items found in your order history yet.
        <br><br>
        Make sure you have past orders on connected platforms.
      <% } else { %>
        Loading your order history...
      <% } %>
    </p>
  </div>
<% } %>
