<h1>Connect Your Accounts</h1>

<p style="color: var(--text-secondary); margin-bottom: 2rem;">
  Two quick steps to get started:
</p>

<!-- Step 1: Bookmarklet -->
<section class="card">
  <h2>Step 1: Drag This Button to Your Bookmarks Bar</h2>
  
  <div style="text-align: center; padding: 2rem; background: var(--bg-secondary); border: 2px dashed var(--border); margin: 1.5rem 0;">
    <a 
      href="<%= bookmarklet %>" 
      class="btn btn-primary"
      style="cursor: grab; font-size: 1rem; padding: 1rem 2rem; display: inline-block;"
      draggable="true"
      id="bookmarklet-btn"
    >
      ðŸ“Ž Connect to Handled
    </a>
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 1rem; margin-bottom: 0;">
      â†‘ Drag this up to your bookmarks bar â†‘
    </p>
  </div>
  
  <p style="color: var(--text-muted); font-size: 0.85rem;">
    <strong>Don't see your bookmarks bar?</strong> Press <kbd>Cmd+Shift+B</kbd> (Mac) or <kbd>Ctrl+Shift+B</kbd> (Windows)
  </p>
  
  <div style="margin-top: 1.5rem;">
    <button id="done-step1" class="btn" onclick="completeStep1()">
      âœ“ Done - I've added it to my bookmarks bar
    </button>
  </div>
</section>

<!-- Step 2: Connect Platforms (hidden until step 1 done) -->
<section class="card" style="margin-top: 2rem;" id="step2">
  <h2>Step 2: Log In & Click the Bookmark</h2>
  <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
    Click each platform below. After logging in, click "ðŸ“Ž Connect to Handled" in your bookmarks bar.
  </p>
  
  <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
    <% Object.entries(platforms).forEach(([key, platform]) => { %>
      <button 
        class="btn platform-btn"
        data-platform="<%= key %>"
        data-url="<%= platform.loginUrl %>"
        onclick="openPlatform('<%= key %>', '<%= platform.loginUrl %>')"
        style="flex: 1; min-width: 150px; padding: 1.5rem; text-align: center;"
      >
        <span class="status" id="status-<%= key %>">â—‹</span>
        <%= platform.name %>
      </button>
    <% }) %>
  </div>

  <div id="platform-instructions" style="padding: 1rem; background: var(--bg-secondary); border-left: 3px solid var(--accent); display: none;">
    <p style="margin: 0; color: var(--text-secondary);">
      <span id="current-platform-name"></span> is now open. 
      <strong>Log in if needed</strong>, then click the <strong>"ðŸ“Ž Connect to Handled"</strong> bookmark.
    </p>
  </div>
</section>

<!-- All Done -->
<section class="card" style="margin-top: 2rem; display: none;" id="all-done">
  <h2 style="color: var(--accent);">âœ“ All Set!</h2>
  <p style="color: var(--text-secondary);">Your accounts are connected. Let's start shopping!</p>
  <a href="/shop" class="btn btn-primary" style="margin-top: 1rem;">Start Shopping â†’</a>
</section>

<script>
const platformNames = {
  ubereats: 'Uber Eats',
  doordash: 'DoorDash', 
  instacart: 'Instacart'
};

const connectedPlatforms = new Set();

function completeStep1() {
  document.getElementById('step2').style.display = 'block';
  document.getElementById('done-step1').innerHTML = 'âœ“ Done!';
  document.getElementById('done-step1').disabled = true;
  document.getElementById('done-step1').style.opacity = '0.5';
}

function openPlatform(platform, url) {
  window.open(url, '_blank');
  document.getElementById('platform-instructions').style.display = 'block';
  document.getElementById('current-platform-name').textContent = platformNames[platform];
}

function markConnected(platform) {
  connectedPlatforms.add(platform);
  const status = document.getElementById('status-' + platform);
  if (status) {
    status.textContent = 'âœ“';
    status.style.color = '#c9a962';
  }
  
  if (connectedPlatforms.size >= 1) {
    document.getElementById('all-done').style.display = 'block';
  }
}

// Check for successful connections by polling
function checkConnections() {
  fetch('/connect/status')
    .then(r => r.json())
    .then(data => {
      data.forEach(p => {
        if (p.connected) markConnected(p.platform);
      });
    })
    .catch(() => {});
}

// Poll every 3 seconds
setInterval(checkConnections, 3000);
checkConnections();
</script>
